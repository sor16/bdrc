<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Introduction • bdrc</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Introduction">
<meta name="robots" content="noindex">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="default" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">bdrc</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">1.1.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/background.html">Background</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/introduction.html">Introduction to bdrc</a></li>
    <li><a class="dropdown-item" href="../articles/tournament.html">Tournament - Model Comparison</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">News</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/sor16/bdrc/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Introduction</h1>
                        <h4 data-toc-skip class="author">Solvi
Rognvaldsson, Rafael Daniel Vias, Birgir Hrafnkelsson and Axel Orn
Jansson</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/sor16/bdrc/blob/HEAD/vignettes/introduction.Rmd" class="external-link"><code>vignettes/introduction.Rmd</code></a></small>
      <div class="d-none name"><code>introduction.Rmd</code></div>
    </div>

    
    
<p>A discharge rating curve is a model that describes the relationship
between water elevation and discharge in a river. The rating curve is
estimated from paired observations of water elevation and discharge and
it is used to predict discharge for a given water elevation. This is the
main practical usage of rating curves, as water elevation is
substantially easier to directly observe than discharge. This R package
implements four different discharge rating curve models using a Bayesian
hierarchical modeling framework:</p>
<ul>
<li><p><code><a href="../reference/plm0.html">plm0()</a></code> - Power-law model with constant log-error
variance.</p></li>
<li><p><code><a href="../reference/plm.html">plm()</a></code> - Power-law model with stage-dependent
log-error variance.</p></li>
<li><p><code><a href="../reference/gplm0.html">gplm0()</a></code> - Generalized power-law model with constant
log-error variance.</p></li>
<li><p><code><a href="../reference/gplm.html">gplm()</a></code> - Generalized power-law model with
stage-dependent log-error variance.</p></li>
</ul>
<p>For further details about the different models, see Hrafnkelsson et
al. (2022). For an brief overview of the underlying theory, see our <a href="background.html">Background</a> vignette.</p>
<p>The models differ in their complexity, <code>gplm</code> being the
most flexible and complex model. We will focus on the use of
<code>gplm</code> throughout this introduction vignette and explore the
different ways to fit the <code>gplm</code> and visualize its output.
However, the API of the functions for the other three models are almost
identical so this vignette also helps users to run those models.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">library</span>(bdrc)</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">set.seed</span>(<span class="dv">1</span>) <span class="co">#set seed for reproducibility</span></span></code></pre></div>
<p>We will use a dataset from a stream gauging station in Sweden, called
Krokfors, that comes with the package:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">data</span>(krokfors)</span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">head</span>(krokfors)</span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a><span class="co">#&gt;          W          Q</span></span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a><span class="co">#&gt; 1 9.478000 10.8211700</span></span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a><span class="co">#&gt; 2 8.698000  1.5010000</span></span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a><span class="co">#&gt; 3 9.009000  3.3190000</span></span>
<span id="cb2-7"><a href="#cb2-7" tabindex="-1"></a><span class="co">#&gt; 4 8.097000  0.1595700</span></span>
<span id="cb2-8"><a href="#cb2-8" tabindex="-1"></a><span class="co">#&gt; 5 9.104000  4.5462500</span></span>
<span id="cb2-9"><a href="#cb2-9" tabindex="-1"></a><span class="co">#&gt; 6 8.133774  0.2121178</span></span></code></pre></div>
<div class="section level2">
<h2 id="fitting-a-discharge-rating-curve">Fitting a discharge rating curve<a class="anchor" aria-label="anchor" href="#fitting-a-discharge-rating-curve"></a>
</h2>
<p>Fitting a discharge rating curve with <code>bdrc</code> is
straightforward. Only two input arguments are mandatory:
<code>formula</code> and <code>data</code>. The <code>formula</code>
should of the form <code>y ~ x</code>, where <code>y</code> is the
discharge in cubic meters per second (m³/s), and <code>x</code> is the
water elevation (stage) in meters (m). It is crucial that the data is in
the correct units! The <code>data</code> argument must be a
<code>data.frame</code> including <code>x</code> and <code>y</code> as
column names. In our case, the Krokfors data has the discharge and water
elevation measurements stored in columns named <code>Q</code> and
<code>W</code>, respectively. We are ready to fit a discharge rating
curve using the <code>gplm</code> function:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="sc">&gt;</span> gplm.fit <span class="ot">&lt;-</span> <span class="fu">gplm</span>(Q <span class="sc">~</span> W, <span class="at">data =</span> krokfors, <span class="at">parallel =</span> <span class="cn">TRUE</span>, <span class="at">num_cores =</span> <span class="dv">2</span>) <span class="co"># by default parallel=TRUE and the number of cores is detected on the machine</span></span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a><span class="co">#&gt; Progress:</span></span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a><span class="co">#&gt; Initializing Metropolis MCMC algorithm...</span></span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a><span class="co">#&gt; Multiprocess sampling (4 chains in 2 jobs) ...</span></span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb3-6"><a href="#cb3-6" tabindex="-1"></a><span class="co">#&gt; MCMC sampling completed!</span></span>
<span id="cb3-7"><a href="#cb3-7" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb3-8"><a href="#cb3-8" tabindex="-1"></a><span class="co">#&gt; Diagnostics:</span></span>
<span id="cb3-9"><a href="#cb3-9" tabindex="-1"></a><span class="co">#&gt; Acceptance rate: 25.33%.</span></span>
<span id="cb3-10"><a href="#cb3-10" tabindex="-1"></a><span class="co">#&gt; ✔ All chains have mixed well (Rhat &lt; 1.1).</span></span>
<span id="cb3-11"><a href="#cb3-11" tabindex="-1"></a><span class="co">#&gt; ✔ Effective sample sizes sufficient (eff_n_samples &gt; 400).</span></span></code></pre></div>
<p>The function prints out a summary of the fitting process and key MCMC
diagnostics. These include the acceptance rate, chain mixing (assessed
via the Gelman-Rubin statistic,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><mi>R</mi><mo accent="true">̂</mo></mover><annotation encoding="application/x-tex">\hat{R}</annotation></semantics></math>),
and effective sample sizes. The checkmarks indicate that the algorithm
has met important criteria for reliability. However, sometimes you may
encounter warnings. For example:</p>
<pre><code><span><span class="co">#&gt; ⚠ Warning: Some chains are not mixing well. Parameters with Rhat &gt; 1.1:</span></span>
<span><span class="co">#&gt;   - sigma_eta: Rhat = 1.281</span></span></code></pre>
<p>This warning suggests that certain parameters (in this case,
sigma_eta) haven’t mixed well across chains, which could affect the
reliability of the results. In such cases, the function provides
advice:</p>
<pre><code><span><span class="co">#&gt; ℹ Try re-running the model after inspecting the trace plots, convergence diagnostics plots, and reviewing the data for potential issues.</span></span></code></pre>
<p>This output helps you assess whether the discharge rating curve has
been fitted successfully and reliably using the specified data. The
function can be made to run silently by setting
<code>verbose=FALSE</code>.</p>
<p>Note that <code>parallel=TRUE</code> is the default setting,
utilizing all available cores on the machine. You can adjust the number
of cores with the <code>num_cores</code> argument if needed.</p>
<p>The <code>gplm</code> function returns an object of class
<em>gplm</em> which we can summarize and visualize using familiar
functions such as</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">summary</span>(gplm.fit)</span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a><span class="co">#&gt; Formula: </span></span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a><span class="co">#&gt;  Q ~ W</span></span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a><span class="co">#&gt; Latent parameters:</span></span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a><span class="co">#&gt;   lower-2.5% median-50% upper-97.5%</span></span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a><span class="co">#&gt; a 1.47       1.94       2.23       </span></span>
<span id="cb6-8"><a href="#cb6-8" tabindex="-1"></a><span class="co">#&gt; b 1.83       1.84       1.84       </span></span>
<span id="cb6-9"><a href="#cb6-9" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb6-10"><a href="#cb6-10" tabindex="-1"></a><span class="co">#&gt; Hyperparameters:</span></span>
<span id="cb6-11"><a href="#cb6-11" tabindex="-1"></a><span class="co">#&gt;            lower-2.5% median-50% upper-97.5%</span></span>
<span id="cb6-12"><a href="#cb6-12" tabindex="-1"></a><span class="co">#&gt; c           7.70955    7.8089     7.855     </span></span>
<span id="cb6-13"><a href="#cb6-13" tabindex="-1"></a><span class="co">#&gt; sigma_beta  0.42275    0.6942     1.258     </span></span>
<span id="cb6-14"><a href="#cb6-14" tabindex="-1"></a><span class="co">#&gt; phi_beta    0.54941    1.1775     2.861     </span></span>
<span id="cb6-15"><a href="#cb6-15" tabindex="-1"></a><span class="co">#&gt; sigma_eta   0.00298    0.0934     0.498     </span></span>
<span id="cb6-16"><a href="#cb6-16" tabindex="-1"></a><span class="co">#&gt; eta_1      -4.91521   -4.2508    -3.535     </span></span>
<span id="cb6-17"><a href="#cb6-17" tabindex="-1"></a><span class="co">#&gt; eta_2      -5.97953   -4.0555    -2.264     </span></span>
<span id="cb6-18"><a href="#cb6-18" tabindex="-1"></a><span class="co">#&gt; eta_3      -6.92387   -4.1874    -1.612     </span></span>
<span id="cb6-19"><a href="#cb6-19" tabindex="-1"></a><span class="co">#&gt; eta_4      -7.66667   -4.4852    -1.160     </span></span>
<span id="cb6-20"><a href="#cb6-20" tabindex="-1"></a><span class="co">#&gt; eta_5      -8.33270   -4.6096    -0.757     </span></span>
<span id="cb6-21"><a href="#cb6-21" tabindex="-1"></a><span class="co">#&gt; eta_6      -8.81259   -4.6718    -0.311     </span></span>
<span id="cb6-22"><a href="#cb6-22" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb6-23"><a href="#cb6-23" tabindex="-1"></a><span class="co">#&gt; WAIC: -27.81763</span></span></code></pre></div>
<p>and</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">plot</span>(gplm.fit)</span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-7-1.png" width="768" style="display: block; margin: auto;"></p>
<p>In the next section, we will dive deeper into visualizing the
<em>gplm</em> object.</p>
</div>
<div class="section level2">
<h2 id="visualizing-posterior-distributions-of-different-parameters">Visualizing posterior distributions of different parameters<a class="anchor" aria-label="anchor" href="#visualizing-posterior-distributions-of-different-parameters"></a>
</h2>
<p>The <code>bdrc</code> package provides several tools to visualize the
results from model objects which can give insight into the physical
properties of the river at hand. For instance, the hyperparameter
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>c</mi><annotation encoding="application/x-tex">c</annotation></semantics></math>
corresponds to the water elevation of zero discharge. To visualize the
posterior of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>c</mi><annotation encoding="application/x-tex">c</annotation></semantics></math>,
we can write</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">plot</span>(gplm.fit, <span class="at">type =</span> <span class="st">'histogram'</span>, <span class="at">param =</span> <span class="st">'c'</span>)</span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-8-1.png" width="768" style="display: block; margin: auto;"></p>
<p>Technically, instead of inferring
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>c</mi><annotation encoding="application/x-tex">c</annotation></semantics></math>
directly,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>h</mi><mrow><mi>m</mi><mi>i</mi><mi>n</mi></mrow></msub><mo>−</mo><mi>c</mi></mrow><annotation encoding="application/x-tex">h_{min}-c</annotation></semantics></math>
is inferred, where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>h</mi><mrow><mi>m</mi><mi>i</mi><mi>n</mi></mrow></msub><annotation encoding="application/x-tex">h_{min}</annotation></semantics></math>
is the lowest water elevation value in the data. Since the parameter
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>h</mi><mrow><mi>m</mi><mi>i</mi><mi>n</mi></mrow></msub><mo>−</mo><mi>c</mi></mrow><annotation encoding="application/x-tex">h_{min}-c</annotation></semantics></math>
is strictly positive, a transformation
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ζ</mi><mo>=</mo><mi>l</mi><mi>o</mi><mi>g</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>h</mi><mrow><mi>m</mi><mi>i</mi><mi>n</mi></mrow></msub><mo>−</mo><mi>c</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\zeta=log(h_{min}-c)</annotation></semantics></math>
is used for the Bayesian inference so that it has support on the real
line. To plot the transformed posterior we write</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">plot</span>(gplm.fit, <span class="at">type =</span> <span class="st">'histogram'</span>, <span class="at">param =</span> <span class="st">'c'</span>, <span class="at">transformed =</span> <span class="cn">TRUE</span>)</span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-9-1.png" width="768" style="display: block; margin: auto;"></p>
<p>The <code>param</code> argument can also be a vector containing
multiple parameter names. For example, to visualize the posterior
distributions of the parameters
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>a</mi><annotation encoding="application/x-tex">a</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>c</mi><annotation encoding="application/x-tex">c</annotation></semantics></math>,
we can write</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">plot</span>(gplm.fit, <span class="at">type =</span> <span class="st">'histogram'</span>, <span class="at">param =</span> <span class="fu">c</span>(<span class="st">'a'</span>, <span class="st">'c'</span>))</span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-10-1.png" width="768" style="display: block; margin: auto;"></p>
<p>There is a shorthand to visualize the hyperparameters all at once</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">plot</span>(gplm.fit, <span class="at">type =</span> <span class="st">'histogram'</span>, <span class="at">param =</span> <span class="st">'hyperparameters'</span>)</span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-11-1.png" width="960" style="display: block; margin: auto;"></p>
<p>Similarly, writing <code>"latent_parameters"</code> plots the latent
parameters in one plot. To plot the hyperparameters transformed on the
same scale as in the Bayesian inference, we write</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">plot</span>(gplm.fit, <span class="at">type =</span> <span class="st">'histogram'</span>, <span class="at">param =</span> <span class="st">'hyperparameters'</span>, <span class="at">transformed =</span> <span class="cn">TRUE</span>)</span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-12-1.png" width="960" style="display: block; margin: auto;"></p>
<p>Finally, we can visualize the components of the model that are
allowed (depending on the model) to vary with water elevation, that is,
the power-law exponent,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>h</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">f(h)</annotation></semantics></math>,
and the standard deviation of the error terms at the response level,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>σ</mi><mi>ε</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>h</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\sigma_{\varepsilon}(h)</annotation></semantics></math>.
Both <code>gplm0</code> and <code>gplm</code> generalize the power-law
exponent by modeling it as a sum of a constant term,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>b</mi><annotation encoding="application/x-tex">b</annotation></semantics></math>,
and Gaussian process,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>β</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>h</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\beta(h)</annotation></semantics></math>,
namely
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>h</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mi>b</mi><mo>+</mo><mi>β</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>h</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">f(h)=b+\beta(h)</annotation></semantics></math>,
where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>β</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>h</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\beta(h)</annotation></semantics></math>
is assumed to be twice differentiable with mean zero. On the other hand,
<code>plm</code> and <code>plm0</code> both model the power-law exponent
as a constant by setting
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>β</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>h</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">\beta(h)=0</annotation></semantics></math>,
which gives
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>h</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mi>b</mi></mrow><annotation encoding="application/x-tex">f(h)=b</annotation></semantics></math>.
We can plot the inferred power-law exponent with</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">plot</span>(gplm.fit, <span class="at">type =</span> <span class="st">'f'</span>)</span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-13-1.png" width="768" style="display: block; margin: auto;"></p>
<p>Both <code>plm</code> and <code>gplm</code> model the standard
deviation of the error terms at the response level,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>σ</mi><mi>ε</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>h</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\sigma_{\varepsilon}(h)</annotation></semantics></math>,
as a function of water elevation, using B-splines basis functions, while
<code>plm0</code> and <code>gplm0</code> model the standard deviation as
a constant. We can plot the inferred standard deviation by writing</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">plot</span>(gplm.fit, <span class="at">type =</span> <span class="st">'sigma_eps'</span>)</span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-14-1.png" width="768" style="display: block; margin: auto;"></p>
<p>To get a visual summary of your model, the <code>"panel"</code>
option in the plot type is useful:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">plot</span>(gplm.fit, <span class="at">type =</span> <span class="st">'panel'</span>, <span class="at">transformed =</span> <span class="cn">TRUE</span>)</span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-15-1.png" width="768" style="display: block; margin: auto;"></p>
</div>
<div class="section level2">
<h2 id="assessing-model-fit-and-convergence">Assessing model fit and convergence<a class="anchor" aria-label="anchor" href="#assessing-model-fit-and-convergence"></a>
</h2>
<p>The package has several functions for convergence diagnostics of a
<code>bdrc</code> model, most notably the residual plot, trace plots,
autocorrelation plots, and Gelman-Rubin diagnostic plots. The
log-residuals can be plotted with</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">plot</span>(gplm.fit, <span class="at">type =</span> <span class="st">'residuals'</span>)</span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-16-1.png" width="768" style="display: block; margin: auto;"></p>
<p>The log-residuals are calculated by subtracting the posterior
estimate (median) of the log-discharge,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi><mi>o</mi><mi>g</mi><mrow><mo stretchy="true" form="prefix">(</mo><mover><mi>Q</mi><mo accent="true">̂</mo></mover><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">log(\hat{Q})</annotation></semantics></math>,
from the observed log-discharge,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi><mi>o</mi><mi>g</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>Q</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">log(Q)</annotation></semantics></math>.
Additionally, the plot includes the 95% predictive intervals of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>log</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>Q</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\log(Q)</annotation></semantics></math>
(- -) and 95% credible intervals for the expected value of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>log</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>Q</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\log(Q)</annotation></semantics></math>
(—), the latter reflecting the rating curve uncertainty.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">plot</span>(gplm.fit, <span class="at">type =</span> <span class="st">'trace'</span>, <span class="at">param =</span> <span class="st">'c'</span>, <span class="at">transformed =</span> <span class="cn">TRUE</span>)</span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-17-1.png" width="960" style="display: block; margin: auto;"></p>
<p>To plot a trace plot for all the transformed hyperparameters, we
write</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">plot</span>(gplm.fit, <span class="at">type =</span> <span class="st">'trace'</span>, <span class="at">param =</span> <span class="st">'hyperparameters'</span>, <span class="at">transformed =</span> <span class="cn">TRUE</span>)</span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-18-1.png" width="960" style="display: block; margin: auto;"></p>
<p>To assess the mixing and convergence of the MCMC chains for each
parameter, you can visualize the Gelman-Rubin statistic,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><mi>R</mi><mo accent="true">̂</mo></mover><annotation encoding="application/x-tex">\hat{R}</annotation></semantics></math>,
as presented by Gelman and Rubin (1992) with:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">plot</span>(gplm.fit, <span class="at">type =</span> <span class="st">'r_hat'</span>)</span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-19-1.png" width="768" style="display: block; margin: auto;"></p>
<p>And finally, autocorrelation of parameters can be assessed with</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">plot</span>(gplm.fit, <span class="at">type =</span> <span class="st">'autocorrelation'</span>)</span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-20-1.png" width="768" style="display: block; margin: auto;"></p>
</div>
<div class="section level2">
<h2 id="customizing-the-models">Customizing the models<a class="anchor" aria-label="anchor" href="#customizing-the-models"></a>
</h2>
<p>There are ways to further customize the <code>gplm</code> function.
In some instances, the parameter of zero discharge,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>c</mi><annotation encoding="application/x-tex">c</annotation></semantics></math>,
is known, and you might want to fix the model parameter to the known
value. In addition, you might want to extrapolate the rating curve to
higher water elevation values by adjusting the maximum water elevation.
Assume 7.65 m is the known value of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>c</mi><annotation encoding="application/x-tex">c</annotation></semantics></math>
and you want to calculate the rating curve for water elevation values up
to 10 m, then your function call would look like this</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" tabindex="-1"></a><span class="sc">&gt;</span> gplm.fit.known_c <span class="ot">&lt;-</span> <span class="fu">gplm</span>(Q <span class="sc">~</span> W, krokfors, <span class="at">c_param =</span> <span class="fl">7.65</span>, <span class="at">h_max =</span> <span class="dv">10</span>, <span class="at">parallel =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="prediction-for-an-equally-spaced-grid-of-water-elevations">Prediction for an equally spaced grid of water elevations<a class="anchor" aria-label="anchor" href="#prediction-for-an-equally-spaced-grid-of-water-elevations"></a>
</h2>
<p>To get rating curve predictions for an equally spaced grid of water
elevation values, you can use the predict function. Note that only
values in the range from
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>c</mi><annotation encoding="application/x-tex">c</annotation></semantics></math>
and h_max are accepted, as that is the range in which the Bayesian
inference was performed</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" tabindex="-1"></a><span class="sc">&gt;</span> h_grid <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">8</span>, <span class="fl">8.2</span>, <span class="at">by =</span> <span class="fl">0.01</span>)</span>
<span id="cb22-2"><a href="#cb22-2" tabindex="-1"></a><span class="sc">&gt;</span> rating_curve_h_grid <span class="ot">&lt;-</span> <span class="fu">predict</span>(gplm.fit, <span class="at">newdata =</span> h_grid)</span>
<span id="cb22-3"><a href="#cb22-3" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">print</span>(rating_curve_h_grid)</span>
<span id="cb22-4"><a href="#cb22-4" tabindex="-1"></a><span class="co">#&gt;       h      lower     median     upper</span></span>
<span id="cb22-5"><a href="#cb22-5" tabindex="-1"></a><span class="co">#&gt; 1  8.00 0.06138853 0.08252241 0.1108601</span></span>
<span id="cb22-6"><a href="#cb22-6" tabindex="-1"></a><span class="co">#&gt; 2  8.01 0.06708762 0.09009315 0.1207313</span></span>
<span id="cb22-7"><a href="#cb22-7" tabindex="-1"></a><span class="co">#&gt; 3  8.02 0.07340524 0.09850833 0.1316830</span></span>
<span id="cb22-8"><a href="#cb22-8" tabindex="-1"></a><span class="co">#&gt; 4  8.03 0.07972287 0.10692352 0.1426346</span></span>
<span id="cb22-9"><a href="#cb22-9" tabindex="-1"></a><span class="co">#&gt; 5  8.04 0.08620981 0.11547827 0.1537808</span></span>
<span id="cb22-10"><a href="#cb22-10" tabindex="-1"></a><span class="co">#&gt; 6  8.05 0.09363849 0.12480929 0.1660087</span></span>
<span id="cb22-11"><a href="#cb22-11" tabindex="-1"></a><span class="co">#&gt; 7  8.06 0.10106716 0.13414031 0.1782366</span></span>
<span id="cb22-12"><a href="#cb22-12" tabindex="-1"></a><span class="co">#&gt; 8  8.07 0.10861541 0.14364701 0.1906011</span></span>
<span id="cb22-13"><a href="#cb22-13" tabindex="-1"></a><span class="co">#&gt; 9  8.08 0.11657272 0.15375469 0.2034327</span></span>
<span id="cb22-14"><a href="#cb22-14" tabindex="-1"></a><span class="co">#&gt; 10 8.09 0.12453002 0.16386237 0.2162643</span></span>
<span id="cb22-15"><a href="#cb22-15" tabindex="-1"></a><span class="co">#&gt; 11 8.10 0.13257126 0.17428375 0.2295413</span></span>
<span id="cb22-16"><a href="#cb22-16" tabindex="-1"></a><span class="co">#&gt; 12 8.11 0.14080833 0.18543710 0.2438577</span></span>
<span id="cb22-17"><a href="#cb22-17" tabindex="-1"></a><span class="co">#&gt; 13 8.12 0.14904540 0.19659045 0.2581741</span></span>
<span id="cb22-18"><a href="#cb22-18" tabindex="-1"></a><span class="co">#&gt; 14 8.13 0.15728247 0.20774380 0.2724905</span></span>
<span id="cb22-19"><a href="#cb22-19" tabindex="-1"></a><span class="co">#&gt; 15 8.14 0.16662200 0.21960922 0.2875367</span></span>
<span id="cb22-20"><a href="#cb22-20" tabindex="-1"></a><span class="co">#&gt; 16 8.15 0.17662981 0.23190628 0.3030253</span></span>
<span id="cb22-21"><a href="#cb22-21" tabindex="-1"></a><span class="co">#&gt; 17 8.16 0.18663761 0.24420333 0.3185138</span></span>
<span id="cb22-22"><a href="#cb22-22" tabindex="-1"></a><span class="co">#&gt; 18 8.17 0.19681441 0.25692028 0.3351942</span></span>
<span id="cb22-23"><a href="#cb22-23" tabindex="-1"></a><span class="co">#&gt; 19 8.18 0.20699699 0.26965158 0.3519154</span></span>
<span id="cb22-24"><a href="#cb22-24" tabindex="-1"></a><span class="co">#&gt; 20 8.19 0.21718541 0.28270330 0.3691020</span></span>
<span id="cb22-25"><a href="#cb22-25" tabindex="-1"></a><span class="co">#&gt; 21 8.20 0.22738677 0.29646391 0.3873184</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<p>Gelman, A., &amp; Rubin, D. B. (1992). <em>Inference from iterative
simulation using multiple sequences</em>, Statistical Science, 7(4),
457–472. doi: <a href="https://doi.org/10.1214/ss/1177011136" class="external-link uri">https://doi.org/10.1214/ss/1177011136</a></p>
<p>Hrafnkelsson, B., Sigurdarson, H., Rögnvaldsson, S., Jansson, A. Ö.,
Vias, R. D., and Gardarsson, S. M. (2022). <em>Generalization of the
power-law rating curve using hydrodynamic theory and Bayesian
hierarchical modeling</em>, Environmetrics, 33(2):e2711. doi: <a href="https://doi.org/10.1002/env.2711" class="external-link uri">https://doi.org/10.1002/env.2711</a></p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://english.hi.is/staff/birgirhr" class="external-link">Birgir Hrafnkelsson</a>, <a href="https://github.com/sor16" class="external-link">Solvi Rognvaldsson</a>, <a href="https://github.com/axelornj" class="external-link">Axel Orn Jansson</a>, Rafael Daníel Vias.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
